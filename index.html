<html>
<canvas id="canvas" height="500" width="1000"></canvas>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="/hashmap.js"></script>
<script>
	var socket = io.connect(window.location.hostname);
	var canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');

	// add border to canvas
	$(canvas).css({'border':'1px solid black'});
	
	// init
	var rectangles = new HashMap(),
		myId, cx, cy,
		tile_size = 10;

	// handle arrow key presses
	$(document).bind("keydown", function (e) {
	    switch(e.keyCode)
	    {
	    	//left
	        case 37:
                draw(cx - tile_size, cy);
                cx -= tile_size;
	        	break;
	        //up
	        case 38:
                draw(cx, cy - tile_size);
                cy -= tile_size;
	        	break;
	        //right
	        case 39:
                draw(cx + tile_size, cy);
                cx += tile_size;
	        	break;
	        //down
	        case 40:
                draw(cx, cy + tile_size);
                cy += tile_size;
	        	break;
	    }

	    // tell the server we've moved
	    socket.emit('move', { 'id': myId, 'loc': { 'x': cx, 'y': cy } });
	});

	function draw (x, y) {
		// clear the canvas
		ctx.clearRect(0, 0, canvas.width, canvas.height);

		// draw others
		rectangles.forEach(function (value, key) {
			if (value.id != myId) {
				ctx.fillRect(value.loc.x, value.loc.y, tile_size, tile_size);
			}
		});

		// draw me
		ctx.fillRect(x, y, tile_size, tile_size);
	}

	socket.on('update', function (data) {
        rectangles._data = data;
        draw(cx, cy);
	});

	socket.on('init', function (data) {
		myId = data.newRect.id;
		cx = data.newRect.loc.x;
		cy = data.newRect.loc.y;
		rectangles._data = data.rectangles;
		
  		draw(cx, cy);
	});
</script>
</html>